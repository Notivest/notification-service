<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body style="margin:0;padding:0;background-color:#f5f7fa;">
<div style="max-width:600px;margin:0 auto;padding:24px;background-color:#ffffff;font-family:'Helvetica Neue',Arial,sans-serif;color:#1f2933;line-height:1.55;">
  <p style="margin:0 0 16px 0;" th:text="${#messages.msg('email.common.greeting', recipientName)}">Hello there,</p>
  <p style="margin:0 0 24px 0;" th:text="${#messages.msg('email.alert.intro', subjectTarget)}">
    We detected a new alert.
  </p>
  <p style="margin:0 0 24px 0;" th:text="${#messages.msg('email.alert.overview', subjectTarget)}">
    We noticed unusual activity. Here is what triggered this alert.
  </p>

  <div style="border:1px solid #e5e7eb;border-radius:12px;padding:20px;margin-bottom:24px;background-color:#f9fafb;">
    <p style="margin:0 0 12px 0;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.08em;color:#6b7280;"
       th:text="${#messages.msg('email.alert.summaryHeading')}">
      Key information
    </p>
    <table role="presentation" style="width:100%;border-collapse:collapse;">
      <tbody>
      <tr>
        <td style="padding:6px 0;width:40%;font-size:14px;color:#6b7280;" th:text="${#messages.msg('email.alert.severity')}">Severity</td>
        <td style="padding:6px 0;font-size:16px;font-weight:600;color:#111827;">
          <span th:text="${#strings.toUpperCase(data['severity'] ?: 'INFO')}">INFO</span>
        </td>
      </tr>
      <tr th:if="${data['occurredAt']}">
        <td style="padding:6px 0;width:40%;font-size:14px;color:#6b7280;" th:text="${#messages.msg('email.alert.occurredAt')}">
          Occurred at
        </td>
        <td style="padding:6px 0;font-size:16px;color:#111827;" th:text="${data['occurredAt']}">2024-06-01T10:15:00Z</td>
      </tr>
      <tr th:if="${data['symbol']}">
        <td style="padding:6px 0;width:40%;font-size:14px;color:#6b7280;" th:text="${#messages.msg('email.alert.symbol')}">Asset</td>
        <td style="padding:6px 0;font-size:16px;color:#111827;" th:text="${data['symbol']}">AAPL</td>
      </tr>
      <tr th:if="${data['ruleKind']}">
        <td style="padding:6px 0;width:40%;font-size:14px;color:#6b7280;">Rule Type</td>
        <td style="padding:6px 0;font-size:16px;color:#111827;" th:text="${#strings.replace(data['ruleKind'], '_', ' ')}">PRICE THRESHOLD</td>
      </tr>
      <tr th:if="${data['metric']}">
        <td style="padding:6px 0;width:40%;font-size:14px;color:#6b7280;" th:text="${#messages.msg('email.alert.metric')}">Signal</td>
        <td style="padding:6px 0;font-size:16px;color:#111827;" th:text="${data['metric']}">Relative Strength Index</td>
      </tr>
      <tr th:if="${data['threshold']}">
        <td style="padding:6px 0;width:40%;font-size:14px;color:#6b7280;" th:text="${#messages.msg('email.alert.threshold')}">Threshold</td>
        <td style="padding:6px 0;font-size:16px;color:#111827;" th:text="${data['threshold']}">70</td>
      </tr>
      <tr th:if="${data['currentValue']}">
        <td style="padding:6px 0;width:40%;font-size:14px;color:#6b7280;" th:text="${#messages.msg('email.alert.currentValue')}">Current value</td>
        <td style="padding:6px 0;font-size:16px;color:#111827;" th:text="${data['currentValue']}">74.3</td>
      </tr>
      </tbody>
    </table>
  </div>

  <div th:if="${data['ruleId'] != null or data['eventId'] != null}">
    <div style="background-color:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:12px 16px;margin-bottom:20px;font-size:12px;color:#6b7280;">
      <table role="presentation" style="width:100%;border-collapse:collapse;">
        <tbody>
        <tr th:if="${data['eventId']}">
          <td style="padding:4px 8px 4px 0;font-weight:600;width:35%;">Event ID:</td>
          <td style="padding:4px 0;font-family:monospace;word-break:break-all;" th:text="${data['eventId']}">550e8400-e29b-41d4-a716-446655440000</td>
        </tr>
        <tr th:if="${data['ruleId']}">
          <td style="padding:4px 8px 4px 0;font-weight:600;width:35%;">Rule ID:</td>
          <td style="padding:4px 0;font-family:monospace;word-break:break-all;" th:text="${data['ruleId']}">550e8400-e29b-41d4-a716-446655440001</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div th:if="${data['ruleParams']}" style="background-color:#fef3c7;border:1px solid #fcd34d;border-radius:8px;padding:16px;margin-bottom:20px;">
    <p style="margin:0 0 12px 0;font-weight:600;font-size:14px;color:#92400e;">Rule Parameters</p>

    <div th:if="${data['ruleKind'] == 'PRICE_THRESHOLD'}" style="font-size:13px;color:#78350f;">
      <p style="margin:0;"><strong>Condition:</strong> Price <span th:text="${#strings.toLowerCase(data['ruleParams']['operator'] ?: 'GTE')}">gte</span> <span th:text="${data['ruleParams']['value'] ?: 'N/A'}">60000</span></p>
    </div>

    <div th:if="${data['ruleKind'] == 'PCT_CHANGE'}" style="font-size:13px;color:#78350f;">
      <p style="margin:0;"><strong>Condition:</strong> % Change <span th:text="${#strings.toLowerCase(data['ruleParams']['operator'] ?: 'GTE')}">gte</span> <span th:text="${data['ruleParams']['pct'] ?: 'N/A'}">5</span>%</p>
      <p style="margin:2px 0 0 0;"><strong>Lookback:</strong> <span th:text="${data['ruleParams']['lookbackBars'] ?: 'N/A'}">20</span> bars | <strong>Basis:</strong> <span th:text="${data['ruleParams']['basis'] ?: 'CLOSE'}">CLOSE</span></p>
    </div>

    <div th:if="${data['ruleKind'] == 'MA_CROSS'}" style="font-size:13px;color:#78350f;">
      <p style="margin:0;"><strong>Fast MA:</strong> <span th:text="${data['ruleParams']['fast'] ?: 'N/A'}">10</span> bars | <strong>Slow MA:</strong> <span th:text="${data['ruleParams']['slow'] ?: 'N/A'}">20</span> bars</p>
      <p style="margin:2px 0 0 0;"><strong>Direction:</strong> <span th:text="${data['ruleParams']['direction'] ?: 'UP'}">UP</span></p>
    </div>

    <div th:if="${data['ruleKind'] == 'RSI'}" style="font-size:13px;color:#78350f;">
      <p style="margin:0;"><strong>RSI Threshold:</strong> <span th:text="${data['ruleParams']['threshold'] ?: 'N/A'}">70</span></p>
      <p style="margin:2px 0 0 0;"><strong>Operator:</strong> <span th:text="${data['ruleParams']['operator'] ?: 'ABOVE'}">ABOVE</span> | <strong>Period:</strong> <span th:text="${data['ruleParams']['period'] ?: '14'}">14</span></p>
      <p style="margin:2px 0 0 0;" th:if="${data['ruleParams']['timeframe']}"><strong>Timeframe:</strong> <span th:text="${data['ruleParams']['timeframe']}">1H</span></p>
    </div>

    <div th:if="${data['ruleKind'] == 'VOLUME_SPIKE'}" style="font-size:13px;color:#78350f;">
      <p style="margin:0;"><strong>Operator:</strong> <span th:text="${data['ruleParams']['operator'] ?: 'ABOVE_MA'}">ABOVE_MA</span></p>
      <p style="margin:2px 0 0 0;" th:if="${data['ruleParams']['multiplier']}"><strong>Multiplier:</strong> <span th:text="${data['ruleParams']['multiplier']}">1.5</span>x</p>
      <p style="margin:2px 0 0 0;"><strong>Lookback:</strong> <span th:text="${data['ruleParams']['lookback'] ?: '20'}">20</span> bars</p>
    </div>

    <div th:if="${data['ruleKind'] != null and !#strings.contains('PRICE_THRESHOLD,PCT_CHANGE,MA_CROSS,RSI,VOLUME_SPIKE', data['ruleKind'])}" style="font-size:13px;color:#78350f;">
      <ul style="margin:0;padding-left:16px;">
        <li th:each="entry : ${data['ruleParams'].entrySet()}">
          <strong th:text="${#strings.replace(#strings.replace(entry.key, '_', ' '), entry.key, entry.key)}">param</strong>: <span th:text="${entry.value}">value</span>
        </li>
      </ul>
    </div>
  </div>

  <div th:if="${data['payload']}" style="background-color:#dbeafe;border:1px solid #93c5fd;border-radius:8px;padding:16px;margin-bottom:20px;">
    <p style="margin:0 0 12px 0;font-weight:600;font-size:14px;color:#0c4a6e;">Event Data</p>
    <table role="presentation" style="width:100%;border-collapse:collapse;font-size:13px;color:#1e40af;">
      <tbody>
      <tr th:each="entry : ${data['payload'].entrySet()}">
        <td style="padding:3px 8px 3px 0;font-weight:600;width:35%;" th:text="${entry.key}">price</td>
        <td style="padding:3px 0;" th:text="${entry.value}">123.45</td>
      </tr>
      </tbody>
    </table>
  </div>

  <div th:if="${data['holdings']}" style="border:1px solid #e5e7eb;border-radius:12px;padding:20px;margin-bottom:24px;background-color:#ffffff;">
    <p style="margin:0 0 12px 0;font-weight:600;font-size:16px;color:#111827;" th:text="${#messages.msg('email.alert.holdingsHeading')}">
      Your holdings
    </p>
    <p th:if="${#lists.isEmpty(data['holdings'])}" style="margin:0;font-size:14px;color:#6b7280;"
       th:text="${#messages.msg('email.alert.holdingsEmpty', data['symbol'] ?: 'asset')}">
      You currently have no holdings for this asset.
    </p>
    <table th:if="${!#lists.isEmpty(data['holdings'])}" role="presentation" style="width:100%;border-collapse:collapse;">
      <thead>
      <tr>
        <th style="text-align:left;padding:6px 0;font-size:13px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;"
            th:text="${#messages.msg('email.alert.holdingsTable.portfolio')}">Portfolio</th>
        <th style="text-align:left;padding:6px 0;font-size:13px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;"
            th:text="${#messages.msg('email.alert.holdingsTable.quantity')}">Quantity</th>
        <th style="text-align:left;padding:6px 0;font-size:13px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;"
            th:text="${#messages.msg('email.alert.holdingsTable.avgCost')}">Average cost</th>
        <th style="text-align:left;padding:6px 0;font-size:13px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;"
            th:text="${#messages.msg('email.alert.holdingsTable.updatedAt')}">Updated at</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="holding : ${data['holdings']}">
        <td style="padding:6px 0;font-size:15px;color:#111827;" th:text="${holding['portfolioName']}">Growth Portfolio</td>
        <td style="padding:6px 0;font-size:15px;color:#111827;" th:text="${holding['quantity']}">10.5</td>
        <td style="padding:6px 0;font-size:15px;color:#111827;" th:text="${holding['avgCost']}">185.32</td>
        <td style="padding:6px 0;font-size:14px;color:#6b7280;" th:text="${holding['updatedAt']}">2024-06-01T11:45:30Z</td>
      </tr>
      </tbody>
    </table>
  </div>

  <div th:if="${data['details']}" style="margin-bottom:24px;">
    <p style="margin:0 0 12px 0;font-weight:600;font-size:16px;color:#111827;" th:text="${#messages.msg('email.alert.detailsHeading')}">
      Additional context
    </p>
    <ul style="margin:0;padding-left:20px;color:#374151;font-size:15px;">
      <li th:each="entry : ${data['details'].entrySet()}">
        <strong th:text="${entry.key}">Key</strong>: <span th:text="${entry.value}">Value</span>
      </li>
    </ul>
  </div>

  <div th:if="${data['highlights']}" style="margin-bottom:24px;">
    <p style="margin:0 0 12px 0;font-weight:600;font-size:16px;color:#111827;" th:text="${#messages.msg('email.alert.highlightsHeading')}">
      What stands out
    </p>
    <ul style="margin:0;padding-left:20px;color:#374151;font-size:15px;">
      <li th:each="highlight : ${data['highlights']}" th:text="${highlight}">Highlight</li>
    </ul>
  </div>

  <div th:if="${data['ctaUrl']}" style="text-align:center;margin-bottom:24px;">
    <a th:href="${data['ctaUrl']}"
       style="display:inline-block;padding:12px 24px;background-color:#2563eb;color:#ffffff;text-decoration:none;font-weight:600;border-radius:8px;"
       th:text="${#messages.msg('email.alert.ctaLabel')}">
      Review alert
    </a>
  </div>

  <p style="margin:0 0 20px 0;color:#6b7280;font-size:14px;" th:text="${#messages.msg('email.alert.dismiss')}">
    You received this alert based on your current notification preferences.
  </p>
  <p style="margin:16px 0 0 0;" th:text="${#messages.msg('email.common.signature')}">Best regards,</p>
</div>
</body>
</html>
